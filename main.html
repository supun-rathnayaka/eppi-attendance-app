<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Dashboard - EPPI</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="main-body">
    <header>
        <div class="header-content">
            <img src="upscalemedia-transformed.jpg" alt="EPPI Logo" class="main-logo">
            <h1>Welcome, <span id="welcomeName">Guest</span></h1>
            <nav>
                <a href="#" id="downloadReportBtn" title="Download Attendance Report">Download Report</a>
                <a href="#" id="logoutLink" class="logout-button">Logout</a>
            </nav>
        </div>
    </header>
    <main class="dashboard-content">
        <h2>Dashboard Overview</h2>
        <div class="dashboard-grid">
            <div class="main-box attendance-box">
                <h3>Attendance</h3>
                <p>Use the camera to mark your attendance with a photo timestamp.</p>
                <div class="attendance-content-area">
                    <button id="markAttendanceBtn" class="primary-action-button">Mark Your Attendance</button>
                    <div id="cameraSection" style="display:none;" class="hidden-camera-section">
                        <h4>Live Camera Feed</h4>
                        <video id="videoFeed" width="100%" height="auto" autoplay playsinline></video>
                        <button id="captureBtn" class="capture-button">Capture Photo</button>
                        <canvas id="canvas" style="display:none;"></canvas>
                        <div id="resultArea" class="result-area" style="display:none;">
                            <h4>Attendance Recorded!</h4>
                            <img id="capturedImage" alt="Captured Attendance Photo" class="captured-photo">
                            <p><strong>Time:</strong> <span id="recordTime"></span></p>
                            <p><strong>Date:</strong> <span id="recordDate"></span></p>
                            <p class="success-note"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-box info-box">
                <h3>Your Info</h3>
                <p>Your personal details and latest record.</p>
                <div class="user-info-details">
                    <p><strong>Logger Name:</strong> <span id="infoName"></span></p>
                    <p><strong>Employer ID:</strong> <span id="infoEmployerId"></span></p>
                </div>
                <h4>Latest Attendance</h4>
                <div id="latestAttendanceDetails">
                    <p><strong>Date:</strong> <span id="latestDate">N/A</span></p>
                    <p><strong>Time:</strong> <span id="latestTime">N/A</span></p>
                </div>
            </div>
            
            <div class="main-box leave-box">
                <h3>Leave Submission</h3>
                <p>Request time off by filling out the form below.</p>
                
                <form id="leaveSubmissionForm">
                    <select id="leaveType" required>
                        <option value="">-- Select Leave Type --</option>
                        <option value="Annual">Annual Leave</option>
                        <option value="Sick">Sick Leave</option>
                        <option value="Emergency">Emergency Leave</option>
                        <option value="Other">Other</option>
                    </select>
                    
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" required>

                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" required>

                    <textarea id="reason" placeholder="Reason for leave (required)" required></textarea>

                    <button type="submit" class="primary-action-button">Submit Leave Request</button>
                    <p id="leave-message" class="error-message"></p>
                </form>
            </div>
            </div>
    </main>
    
    <script src="attendance.js"></script>
    <script>
        const userName = localStorage.getItem('eppi_user_name');
        const employerId = localStorage.getItem('eppi_employer_id');
        
        // Retrieve and display latest attendance from localStorage on load
        const latestDate = localStorage.getItem('eppi_latest_date');
        const latestTime = localStorage.getItem('eppi_latest_time');

        if (!userName || !employerId) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('welcomeName').textContent = userName;
            document.getElementById('infoName').textContent = userName;
            document.getElementById('infoEmployerId').textContent = employerId;
            
            // Display stored latest attendance if available
            if (latestDate && latestTime) {
                document.getElementById('latestDate').textContent = latestDate;
                document.getElementById('latestTime').textContent = latestTime;
            }
        }

        document.getElementById('logoutLink').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'index.html';
        });

        // Report download functionality (Admin Access Check)
        document.getElementById('downloadReportBtn').addEventListener('click', (e) => {
            e.preventDefault();
            // Pass employerId for server-side check
            window.open(`/api/attendance/report?employerId=${employerId}`, '_blank'); 
        });

        // Leave Submission functionality
        document.getElementById('leaveSubmissionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const leaveMessage = document.getElementById('leave-message');
            leaveMessage.textContent = 'Submitting...';
            leaveMessage.style.color = 'blue';

            const leaveData = {
                employerId: employerId, // Retrieved from local storage
                loggerName: userName,   // Retrieved from local storage
                leaveType: document.getElementById('leaveType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                reason: document.getElementById('reason').value
            };

            fetch('/api/leave/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leaveData)
            })
            .then(response => response.json())
            .then(data => {
                leaveMessage.textContent = data.message;
                leaveMessage.style.color = data.success ? 'green' : 'red';
                if (data.success) {
                    document.getElementById('leaveSubmissionForm').reset();
                }
            })
            .catch(error => {
                leaveMessage.textContent = 'Failed to submit request: Server error.';
                leaveMessage.style.color = 'red';
                console.error('Leave Submit Error:', error);
            });
        });
    </script>
</body>
</html>